<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Coding week21 10/21-10/27 | Zebin Huang | JdeRobot x GSoC2024 </title> <meta name="author" content="Zebin Huang"> <meta name="description" content="Modifications to PilotNetOneHot model to incorporate distance-aware control"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/gsoc2024-ZebinHuang/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/gsoc2024-ZebinHuang/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/gsoc2024-ZebinHuang/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/gsoc2024-ZebinHuang/assets/img/logo.png?a3cac8c2613225704682d343b37ffd84"> <link rel="stylesheet" href="/gsoc2024-ZebinHuang/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://theroboticsclub.github.io/gsoc2024-ZebinHuang/blog/2024/week21/"> <script src="/gsoc2024-ZebinHuang/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/gsoc2024-ZebinHuang/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/gsoc2024-ZebinHuang/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js" integrity="sha256-rjmgmaB99riUNcdlrDtcAiwtLIojSxNyUFdl+Qh+rB4=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="/gsoc2024-ZebinHuang/assets/js/distillpub/template.v2.js"></script> <script src="/gsoc2024-ZebinHuang/assets/js/distillpub/transforms.v2.js"></script> <script src="/gsoc2024-ZebinHuang/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "Coding week21 10/21-10/27",
            "description": "Modifications to PilotNetOneHot model to incorporate distance-aware control",
            "published": "October 21, 2024",
            "authors": [
              
              {
                "author": "Zebin Huang",
                "authorURL": "",
                "affiliations": [
                  {
                    "name": "Edinburgh Centre for Robotics",
                    "url": ""
                  }
                ]
              }
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/gsoc2024-ZebinHuang/"> Zebin Huang | JdeRobot x GSoC2024 </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/gsoc2024-ZebinHuang/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/gsoc2024-ZebinHuang/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/gsoc2024-ZebinHuang/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Coding week21 10/21-10/27</h1> <p>Modifications to PilotNetOneHot model to incorporate distance-aware control</p> </d-title> <d-byline></d-byline> <d-article> <p>This week, we focused on the integration of new command functionalities. We introduced a distance-based command to help the model learn state transitions. This post outlines the modifications made to the <code class="language-plaintext highlighter-rouge">PilotNetOneHot</code> model to incorporate a new command <code class="language-plaintext highlighter-rouge">Run50</code> an additional input, <code class="language-plaintext highlighter-rouge">distance</code>, which is a vector of size 1 range within (0,50) meters. Key changes were made in the model’s architecture.</p> <h3 id="data-collection">Data Collection</h3> <p>This section explains how the data collection process integrates distance commands.</p> <p>The <code class="language-plaintext highlighter-rouge">distance</code> vector is a critical part of the dataset as it determines how the vehicle behaves in response to the target distance. Specifically, when the vehicle is within a 50-meter range of a stopping point, the corresponding control commands will reflect a reduction in throttle and an increase in braking, teaching the model to stop the vehicle.</p> <p>When the vehicle reaches or exceeds a distance of 50 meters from the target, the data reflects a command to stop. During training, the model will learn to replicate this behaviour, applying the brake and reducing the throttle when the vehicle is within 50 meters of the stopping point.</p> <p>For example, during data collection, when the distance reaches 50 meters, the control signals recorded will show a reduction in throttle and an increase in braking:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">distance</span> <span class="o">=</span> <span class="mf">50.0</span>
<span class="n">controls</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">throttle</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Reduce throttle to 0 to stop the vehicle
</span>    <span class="sh">'</span><span class="s">brake</span><span class="sh">'</span><span class="p">:</span> <span class="mf">1.0</span>      <span class="c1"># Apply brake to stop the vehicle
</span><span class="p">}</span>
</code></pre></div></div> <p>In the collected data, the “Run50” command appears infrequently. Therefore, we extracted the segments containing this command for model training.</p> <h3 id="model-initialization">Model Initialization</h3> <p>The structure of the <code class="language-plaintext highlighter-rouge">PilotNetOneHot</code> model remains unchanged. The key change is in the fully connected layers, where we account for the additional <code class="language-plaintext highlighter-rouge">distance</code> input. The name for the new model is PilotNetOneHotDistance.</p> <p>Since we are adding a <code class="language-plaintext highlighter-rouge">distance</code> input with a size of 50, the updated initialization becomes:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self</span><span class="p">.</span><span class="n">fc_1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">35</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">num_hlc</span> <span class="o">+</span> <span class="n">num_light</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</code></pre></div></div> <p>In the original model, the forward pass handled the concatenation of the image features, speed, HLC, and traffic light inputs. Now, we modify the forward pass to include the <code class="language-plaintext highlighter-rouge">distance</code> as well.</p> <p>This modification allows the model to process the <code class="language-plaintext highlighter-rouge">distance</code> input along with the existing features. The <code class="language-plaintext highlighter-rouge">distance</code> input is concatenated with the flattened image features, speed, HLC, and traffic light data before being passed through the fully connected layers.</p> <p>The updated forward pass in the training loop becomes:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
    <span class="n">img</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">hlc</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">controls</span> <span class="o">=</span> <span class="n">data</span>  <span class="c1"># Include distance
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">hlc</span> <span class="o">=</span> <span class="n">hlc</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">light</span> <span class="o">=</span> <span class="n">light</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">controls</span> <span class="o">=</span> <span class="n">controls</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Forward pass
</span>    <span class="n">outputs</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">hlc</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="nf">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">controls</span><span class="p">)</span>

    <span class="c1"># Backward pass and optimization
</span>    <span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>
    <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>
</code></pre></div></div> <p>In the video, the final distance is set to 44 meters. This could be because, within the 0–50 meter training, the model encounters situations like waiting at traffic lights or stopping for obstacles. Such instances may reduce the model’s ability to learn precise control.</p> <iframe width="700" height="500" src="https://www.youtube.com/embed/LZzG00QXZI8" title="Run50 44m" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe> <p>We also tested switching to a high-level command. In the following video, you can see an action transition, although there is a delay when restarting. This delay might occur because, during data collection, distinct states are triggered, and the model has mostly learned the stop command. As a result, after executing the <code class="language-plaintext highlighter-rouge">Run50</code> command, the model defaults to a stop signal, needing extra time to switch to the next high-level command.</p> <iframe width="700" height="500" src="https://www.youtube.com/embed/9egxvlqG-0k" title="Run50 LaneFollow" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/gsoc2024-ZebinHuang/assets/bibliography/posts.bib"></d-bibliography> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Zebin Huang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="/gsoc2024-ZebinHuang/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>